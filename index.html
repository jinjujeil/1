<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ í•™ì› ê´€ë¦¬ ëŒ€ì¥</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: #f3f4f6; margin: 0; padding: 10px; padding-top: 50px; }
        
        /* ìƒë‹¨ ì‹œê³„ ì˜ì—­ */
        .header-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #fff; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .header-title { font-weight: bold; font-size: 1.1rem; color: #333; }
        .header-clock { font-weight: bold; color: #2563eb; font-size: 0.9rem; }

        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 50px;}

        /* --- ì»¨íŠ¸ë¡¤ íŒ¨ë„ (êµì‹œ ì„ íƒ) --- */
        .control-panel { margin-bottom: 20px; padding: 10px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0; }
        .period-selector { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
        .period-btn { 
            padding: 8px 12px; border: 1px solid #cbd5e1; background: white; 
            border-radius: 20px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; 
            transition: all 0.2s;
        }
        .period-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; font-weight: bold; }
        .period-btn.day-record { border-color: #ef4444; color: #ef4444; }
        .period-btn.day-record.active { background: #ef4444; color: white; }

        /* ë°˜ ì„ íƒ íƒ­ */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #e5e7eb; cursor: pointer; border-radius: 8px; font-weight: bold; min-width: 60px; white-space: nowrap; font-size: 0.9rem;}
        .tab-btn.active { background: #3b82f6; color: white; }

        /* --- ì¢Œì„ ê·¸ë¦¬ë“œ --- */
        .seat-grid-wrapper { overflow-x: auto; padding-bottom: 5px; margin-top: 10px; border-radius: 10px; background: #eee; border: 1px solid #ddd; }
        .seat-grid { display: grid; gap: 6px; padding: 10px; min-width: 600px; }
        
        .seat {
            aspect-ratio: 1.3; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 2px solid #ccc; border-radius: 6px; cursor: pointer; user-select: none;
            background: white; padding: 2px; text-align: center; position: relative; transition: all 0.1s;
        }
        .seat-name { font-weight: bold; font-size: 1rem; line-height: 1.2; }
        .seat-status { font-size: 0.75rem; margin-top: 2px; }

        /* ìƒíƒœë³„ ìƒ‰ìƒ (ì „ì²´ê¸°ë¡ìš©) */
        .seat.absent { border-color: #dc2626; background-color: #fef2f2; color: #991b1b; } 
        .seat.early { border-color: #d97706; background-color: #fffbeb; color: #92400e; }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ (êµì‹œë³„) */
        .seat.missing { border-color: #6b7280; background-color: #f3f4f6; color: #6b7280; opacity: 0.7; } /* ìë¦¬ì— ì—†ìŒ */

        .seat.present { border-color: #059669; background-color: #ecfdf5; color: #065f46; } /* ì¶œì„ */

        .seat.hidden-seat { visibility: hidden; pointer-events: none; }
        .editing .seat.hidden-seat { visibility: visible; opacity: 0.3; background: #999; border: 1px dashed #666; pointer-events: auto; }

        /* --- ê´€ë¦¬ ëŒ€ì¥ (í‘œ) ìŠ¤íƒ€ì¼ --- */
        .logbook-section { margin-top: 40px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .logbook-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #1e293b; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 600px; }
        th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: center; vertical-align: middle; }
        th { background: #f1f5f9; font-weight: bold; color: #334155; }
        
        /* í‘œ ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .cell-count { font-size: 1.1rem; font-weight: bold; color: #333; display: block; }
        .cell-names { font-size: 0.75rem; color: #dc2626; margin-top: 4px; display: block; line-height: 1.2; }
        .row-header { background: #f8fafc; font-weight: bold; width: 60px; }
        
        /* ë²„íŠ¼ë“¤ */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
        .btn-update { background: #4b5563; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-medical { background: #4f46e5; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        
        .layout-controls { background: #f0fdf4; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; text-align: right;}
        .layout-controls.show { display: block; }
        .switch-group { display: flex; gap: 10px; align-items: center; justify-content: flex-end; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="header-bar">
    <div class="header-title">ğŸ“… í•™ì›ìƒ ê´€ë¦¬ ëŒ€ì¥</div>
    <div class="header-clock" id="seoulClock">ë¡œë”©ì¤‘...</div>
</div>

<div class="container">
    <div class="control-panel">
        <div class="switch-group">
            <label style="display:flex; align-items:center; gap:5px; font-size:13px; cursor:pointer;">
                <input type="checkbox" id="modeEditName"> ğŸ“ì´ë¦„ìˆ˜ì •
            </label>
            <label style="display:flex; align-items:center; gap:5px; font-size:13px; cursor:pointer; color:blue;">
                <input type="checkbox" id="modeLayout"> ğŸ—ï¸ìë¦¬ë°°ì¹˜
            </label>
        </div>

        <div class="period-selector" id="periodSelector">
            </div>
        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
            ğŸ“¢ <span id="periodInfoText">ì „ì²´ ê¸°ë¡ ëª¨ë“œ: ê²°ì„/ì¡°í‡´ìë¥¼ ì²´í¬í•˜ì„¸ìš”.</span>
        </div>
    </div>

    <div class="tabs" id="classTabs"></div>

    <div id="layoutControls" class="layout-controls">
        ê°€ë¡œ: <input type="number" id="colsInput" min="1" max="10" style="width:40px;"> 
        ì„¸ë¡œ: <input type="number" id="rowsInput" min="1" max="15" style="width:40px;"> 
        <button class="btn-update" id="btnResize">ì¹¸ìˆ˜ë³€ê²½</button>
        <button class="btn-medical" id="btnLoadMedical" style="margin-left:10px;">ğŸ“¸ì˜ëŒ€ë°˜(101) ì´ˆê¸°í™”</button>
    </div>

    <div class="seat-grid-wrapper">
        <div id="seatGrid" class="seat-grid">
            <div style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë”©ì¤‘...</div>
        </div>
    </div>

    <div class="logbook-section">
        <div class="logbook-title">ğŸ“‹ ì‹¤ì‹œê°„ ê´€ë¦¬ ëŒ€ì¥ (ìë™ì‘ì„±)</div>
        <div class="table-wrapper">
            <table id="logbookTable">
                </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ğŸ”´ [ì¤‘ìš”] ì—¬ê¸°ì— ì„ ìƒë‹˜ Firebase í‚¤ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”! ğŸ”´
    const firebaseConfig = {
        apiKey: "AIzaSyAGdK_AGLtW0DpTvJ3KKrdfq_InIBUI-lY",
        authDomain: "attendence-e9aa8.firebaseapp.com",
        projectId: "attendence-e9aa8",
        storageBucket: "attendence-e9aa8.firebasestorage.app",
        messagingSenderId: "449396483783",
        appId: "1:449396483783:web:091b692225089b85a140e2",
        measurementId: "G-5DW7DFXBSC"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // --- ì „ì—­ ë³€ìˆ˜ ---
    const CLASSES = ['ì˜ëŒ€ë°˜(101)', 'Bë°˜', 'Cë°˜', 'Dë°˜', 'Eë°˜', 'Fë°˜'];
    let currentClassIndex = 0;
    let currentPeriod = 'day'; // 'day'(ì „ì²´), '1', '2' ... '8'
    let todayStr = getTodayString();
    
    // ë°ì´í„° ì €ì¥ì†Œ
    let dbLayout = {}; // í•™ìƒ ì´ë¦„, ìë¦¬ë°°ì¹˜ (ê³ ì •ê°’)
    let dbLog = {};    // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¶œì„ê¸°ë¡ (ë³€ë™ê°’)

    // --- DOM ìš”ì†Œ ---
    const clockEl = document.getElementById('seoulClock');
    const periodSelectorEl = document.getElementById('periodSelector');
    const infoTextEl = document.getElementById('periodInfoText');
    const gridEl = document.getElementById('seatGrid');
    const tabsEl = document.getElementById('classTabs');
    const logbookTableEl = document.getElementById('logbookTable');
    const chkEditName = document.getElementById('modeEditName');
    const chkLayout = document.getElementById('modeLayout');
    const layoutControls = document.getElementById('layoutControls');

    // --- 1. ì‹œê³„ ê¸°ëŠ¥ ---
    function updateClock() {
        const now = new Date();
        const options = { timeZone: 'Asia/Seoul', month: 'long', day: 'numeric', weekday: 'short', hour: '2-digit', minute: '2-digit', second: '2-digit' };
        clockEl.innerText = now.toLocaleString('ko-KR', options);
    }
    setInterval(updateClock, 1000);
    updateClock();

    function getTodayString() {
        // í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë‚ ì§œ ë¬¸ìì—´ ìƒì„± (YYYY-MM-DD)
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const krTime = new Date(now.getTime() + offset + (9 * 60 * 60 * 1000)); 
        return krTime.toISOString().split('T')[0];
    }

    // --- 2. êµì‹œ ì„ íƒ ë²„íŠ¼ ìƒì„± ---
    function renderPeriodButtons() {
        periodSelectorEl.innerHTML = '';
        
        // ì „ì²´ ê¸°ë¡ (ê²°ì„/ì¡°í‡´)
        const btnDay = document.createElement('button');
        btnDay.className = `period-btn day-record ${currentPeriod === 'day' ? 'active' : ''}`;
        btnDay.innerText = 'ì „ì²´ëª…ë‹¨(ê²°ì„/ì¡°í‡´)';
        btnDay.onclick = () => changePeriod('day');
        periodSelectorEl.appendChild(btnDay);

        // 1~8êµì‹œ
        for(let i=1; i<=8; i++) {
            const btn = document.createElement('button');
            btn.className = `period-btn ${currentPeriod === String(i) ? 'active' : ''}`;
            btn.innerText = `${i}êµì‹œ`;
            btn.onclick = () => changePeriod(String(i));
            periodSelectorEl.appendChild(btn);
        }
    }

    function changePeriod(period) {
        currentPeriod = period;
        renderPeriodButtons();
        
        if (period === 'day') {
            infoTextEl.innerText = "ì „ì²´ ê¸°ë¡ ëª¨ë“œ: ì˜¤ëŠ˜ ê²°ì„í•˜ê±°ë‚˜ ì¡°í‡´í•œ í•™ìƒì„ ì²´í¬í•˜ì„¸ìš”.";
        } else {
            infoTextEl.innerText = `${period}êµì‹œ ëª¨ë“œ: í˜„ì¬ ìë¦¬ì— ì—†ëŠ” í•™ìƒì„ ì²´í¬í•˜ì„¸ìš”. (ê²°ì„ìƒì€ ìë™ ì œì™¸ë¨)`;
        }
        renderSeats();
    }

    // --- 3. Firebase ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
    // (1) ìë¦¬ ë°°ì¹˜ ë¶ˆëŸ¬ì˜¤ê¸°
    const layoutRef = ref(database, 'academy/config');
    onValue(layoutRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            dbLayout = data;
        } else {
            initLayoutDB();
        }
        renderSeats(); // ë°°ì¹˜ ë°ì´í„° ì˜¤ë©´ ê·¸ë¦¼
        renderLogbook(); // í‘œë„ ê·¸ë¦¼
    });

    // (2) ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë‚ ì§œë³„ ë¶„ë¦¬)
    const logRef = ref(database, `academy/logs/${todayStr}`);
    onValue(logRef, (snapshot) => {
        dbLog = snapshot.val() || {};
        renderSeats(); // ê¸°ë¡ ë°”ë€Œë©´ ì¢Œì„ ê°±ì‹ 
        renderLogbook(); // í‘œ ê°±ì‹ 
    });

    function initLayoutDB() {
        let initialData = {};
        CLASSES.forEach((cls, idx) => {
            initialData[idx] = {
                name: cls,
                rows: 6,
                cols: 5,
                students: Array(30).fill(null).map(() => ({ name: "ë¹ˆìë¦¬", isVisible: true }))
            };
        });
        set(ref(database, 'academy/config'), initialData);
    }

    // --- 4. ë©”ì¸ í™”ë©´ (ì¢Œì„í‘œ) ê·¸ë¦¬ê¸° ---
    function renderSeats() {
        // íƒ­ ê·¸ë¦¬ê¸°
        tabsEl.innerHTML = '';
        CLASSES.forEach((clsName, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentClassIndex ? 'active' : ''}`;
            btn.innerText = dbLayout[idx]?.name || clsName;
            btn.onclick = () => { currentClassIndex = idx; renderSeats(); };
            tabsEl.appendChild(btn);
        });

        const layoutData = dbLayout[currentClassIndex];
        if(!layoutData) return;

        // UI ëª¨ë“œ ì²˜ë¦¬
        if(chkLayout.checked) {
            layoutControls.classList.add('show');
            gridEl.classList.add('editing');
            chkEditName.checked = false;
        } else {
            layoutControls.classList.remove('show');
            gridEl.classList.remove('editing');
        }

        // ì…ë ¥ì°½ ë™ê¸°í™”
        document.getElementById('colsInput').value = layoutData.cols;
        document.getElementById('rowsInput').value = layoutData.rows;

        // ê·¸ë¦¬ë“œ ì„¤ì •
        gridEl.innerHTML = '';
        gridEl.style.gridTemplateColumns = `repeat(${layoutData.cols}, 1fr)`;

        // í•™ìƒ ë£¨í”„
        layoutData.students.forEach((student, seatIdx) => {
            const seat = document.createElement('div');
            let status = 0; // 0:ì¶œì„, 1:ê²°ì„, 2:ì¡°í‡´, 3:êµì‹œì´íƒˆ

            // í˜„ì¬ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
            const classLog = dbLog[currentClassIndex] || {};
            
            // 'day' ëª¨ë“œì¼ ë•ŒëŠ” ì „ì²´ ê¸°ë¡(Day) í™•ì¸
            // êµì‹œ ëª¨ë“œì¼ ë•ŒëŠ” í•´ë‹¹ êµì‹œ ê¸°ë¡ í™•ì¸
            if(currentPeriod === 'day') {
                status = classLog[`day_${seatIdx}`] || 0; 
            } else {
                // ë§Œì•½ 'Day'ê¸°ë¡ì— ê²°ì„(1)ì´ ìˆìœ¼ë©´ êµì‹œì—ì„œë„ ìë™ìœ¼ë¡œ ë¹ ì§„ê±¸ë¡œ ì²˜ë¦¬(í•˜ì§€ë§Œ ì‹œê°ì ìœ¼ë¡  ë‹¤ë¥´ê²Œ?)
                const dayStatus = classLog[`day_${seatIdx}`] || 0;
                if(dayStatus === 1) {
                    status = 1; // ì´ë¯¸ ê²°ì„ì„
                } else if(dayStatus === 2) {
                    status = 2; // ì¡°í‡´ì„
                } else {
                    status = classLog[`p${currentPeriod}_${seatIdx}`] || 0; // 0 or 3(ì´íƒˆ)
                }
            }

            // ìŠ¤íƒ€ì¼ ì ìš©
            seat.className = 'seat';
            if(student.isVisible === false) seat.classList.add('hidden-seat');
            
            let statusText = "ì¶œì„";
            if(status === 0) { seat.classList.add('present'); }
            else if(status === 1) { seat.classList.add('absent'); statusText = "ê²°ì„"; }
            else if(status === 2) { seat.classList.add('early'); statusText = "ì¡°í‡´"; }
            else if(status === 3) { seat.classList.add('missing'); statusText = "ì´ì„"; }

            // êµì‹œ ëª¨ë“œì¸ë° ì¶œì„(0)ì´ë©´, ê·¸ëƒ¥ ê¹”ë”í•˜ê²Œ ì•„ë¬´ ìƒ‰/í…ìŠ¤íŠ¸ ì—†ê²Œ í• ìˆ˜ë„ ìˆì§€ë§Œ, 
            // "ì¶œì„"ì´ë¼ê³  ëª…ì‹œí•˜ëŠ”ê²Œ í—·ê°ˆë¦¬ì§€ ì•ŠìŒ.
            
            seat.innerHTML = `
                <div class="seat-name">${student.name}</div>
                ${ student.isVisible ? `<div class="seat-status">${statusText}</div>` : '' }
            `;

            seat.onclick = () => handleSeatClick(seatIdx, student);
            gridEl.appendChild(seat);
        });
    }

    // --- 5. ì¢Œì„ í´ë¦­ ë¡œì§ ---
    function handleSeatClick(seatIdx, student) {
        if(chkLayout.checked) {
            // ë°°ì¹˜ ìˆ˜ì •
            const newData = {...student};
            newData.isVisible = !(newData.isVisible ?? true);
            if(newData.isVisible) newData.name = "ë¹ˆìë¦¬";
            
            const updatedStudents = [...dbLayout[currentClassIndex].students];
            updatedStudents[seatIdx] = newData;
            set(ref(database, `academy/config/${currentClassIndex}/students`), updatedStudents);
            return;
        }

        if(chkEditName.checked) {
            // ì´ë¦„ ìˆ˜ì • (config ì €ì¥)
            if(student.isVisible === false) return;
            const newName = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", student.name);
            if(newName !== null) {
                set(ref(database, `academy/config/${currentClassIndex}/students/${seatIdx}/name`), newName);
            }
            return;
        }

        if(student.isVisible === false) return;

        // ì¶œì„ ì²´í¬ (logs ì €ì¥)
        // í˜„ì¬ ìƒíƒœ ì½ê¸°
        const classLog = dbLog[currentClassIndex] || {};
        let nextStatus = 0;

        if (currentPeriod === 'day') {
            // ì „ì²´ ëª¨ë“œ: ì¶œì„(0) -> ê²°ì„(1) -> ì¡°í‡´(2) -> ì¶œì„(0)
            const currentStatus = classLog[`day_${seatIdx}`] || 0;
            nextStatus = (currentStatus + 1) % 3;
            set(ref(database, `academy/logs/${todayStr}/${currentClassIndex}/day_${seatIdx}`), nextStatus);
        } else {
            // êµì‹œ ëª¨ë“œ: ì¶œì„(0) -> ì´ì„(3) -> ì¶œì„(0)
            // ë‹¨, ì´ë¯¸ ê²°ì„/ì¡°í‡´ì¸ í•™ìƒì€ ìˆ˜ì • ë¶ˆê°€
            const dayStatus = classLog[`day_${seatIdx}`] || 0;
            if(dayStatus !== 0) {
                alert("ê²°ì„ ë˜ëŠ” ì¡°í‡´í•œ í•™ìƒì…ë‹ˆë‹¤. 'ì „ì²´ëª…ë‹¨' íƒ­ì—ì„œ ìˆ˜ì •í•˜ì„¸ìš”.");
                return;
            }
            const currentPStatus = classLog[`p${currentPeriod}_${seatIdx}`] || 0;
            nextStatus = (currentPStatus === 0) ? 3 : 0;
            set(ref(database, `academy/logs/${todayStr}/${currentClassIndex}/p${currentPeriod}_${seatIdx}`), nextStatus);
        }
    }

    // --- 6. ê´€ë¦¬ ëŒ€ì¥ (í‘œ) ê·¸ë¦¬ê¸° ---
    function renderLogbook() {
        let html = `<thead><tr><th class="row-header">êµ¬ë¶„</th>`;
        
        // í—¤ë” (ë°˜ ì´ë¦„)
        CLASSES.forEach((cls, idx) => {
            html += `<th>${dbLayout[idx]?.name || cls}</th>`;
        });
        html += `</tr></thead><tbody>`;

        // 1. ì´ì› Row
        html += `<tr><td class="row-header">ì´ì›</td>`;
        CLASSES.forEach((cls, idx) => {
            const students = dbLayout[idx]?.students || [];
            const count = students.filter(s => s.isVisible !== false && s.name !== "ë¹ˆìë¦¬").length;
            html += `<td>${count}</td>`;
        });
        html += `</tr>`;

        // 2. ë¯¸ë“±ì›(ê²°ì„) Row
        html += `<tr><td class="row-header">ë¯¸ë“±ì›<br>(ê²°ì„)</td>`;
        CLASSES.forEach((cls, idx) => {
            const names = getNamesByStatus(idx, 'day', 1); // 1: ê²°ì„
            html += `<td>${names.length > 0 ? `<span class="cell-names">${names.join(', ')}</span>` : '-'}</td>`;
        });
        html += `</tr>`;

        // 3. ì¡°í‡´ Row
        html += `<tr><td class="row-header">ì¡°í‡´</td>`;
        CLASSES.forEach((cls, idx) => {
            const names = getNamesByStatus(idx, 'day', 2); // 2: ì¡°í‡´
            html += `<td>${names.length > 0 ? `<span class="cell-names">${names.join(', ')}</span>` : '-'}</td>`;
        });
        html += `</tr>`;

        // 4. 1~8êµì‹œ Row
        for(let i=1; i<=8; i++) {
            html += `<tr><td class="row-header">${i}êµì‹œ</td>`;
            CLASSES.forEach((cls, idx) => {
                const result = getPeriodStats(idx, i);
                html += `<td>
                    <span class="cell-count">${result.presentCount}</span>
                    ${result.missingNames.length > 0 ? `<span class="cell-names">(${result.missingNames.join(', ')})</span>` : ''}
                </td>`;
            });
            html += `</tr>`;
        }

        html += `</tbody>`;
        logbookTableEl.innerHTML = html;
    }

    // í—¬í¼: íŠ¹ì • ìƒíƒœ(ê²°ì„/ì¡°í‡´)ì¸ í•™ìƒ ì´ë¦„ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    function getNamesByStatus(classIdx, type, targetStatus) {
        const students = dbLayout[classIdx]?.students || [];
        const classLog = dbLog[classIdx] || {};
        let names = [];

        students.forEach((s, seatIdx) => {
            if(s.isVisible === false || s.name === "ë¹ˆìë¦¬") return;
            const status = classLog[`day_${seatIdx}`] || 0;
            if(status === targetStatus) names.push(s.name);
        });
        return names;
    }

    // í—¬í¼: êµì‹œë³„ í†µê³„ (ì¶œì„ìˆ˜, ìë¦¬ì— ì—†ëŠ” ì‚¬ëŒ ëª…ë‹¨)
    function getPeriodStats(classIdx, period) {
        const students = dbLayout[classIdx]?.students || [];
        const classLog = dbLog[classIdx] || {};
        
        let presentCount = 0;
        let missingNames = [];

        students.forEach((s, seatIdx) => {
            if(s.isVisible === false || s.name === "ë¹ˆìë¦¬") return;

            const dayStatus = classLog[`day_${seatIdx}`] || 0;
            const pStatus = classLog[`p${period}_${seatIdx}`] || 0;

            // ìë¦¬ì— ì—†ëŠ” ê²½ìš°: ê²°ì„(1)ì´ê±°ë‚˜, ì¡°í‡´(2)ì´ê±°ë‚˜, í•´ë‹¹êµì‹œì´íƒˆ(3)
            if (dayStatus === 1 || dayStatus === 2 || pStatus === 3) {
                // ê²°ì„/ì¡°í‡´ìë„ í•´ë‹¹ êµì‹œì— ì´ë¦„ í‘œì‹œí• ì§€? -> ì‚¬ì§„ì—” ì—†ìŒ. 
                // ì‚¬ì§„ì—” "ìë¦¬ì— ì—†ëŠ”ë° ì¶œì„ì´ì–´ì•¼ í•˜ëŠ” ì‚¬ëŒ"ë§Œ í‘œì‹œí•˜ëŠ”ë“¯ í•˜ì§€ë§Œ
                // ì„ ìƒë‹˜ ìš”ì²­ì€ "ê²°ì„ì´ë‘, ì¶œì„ì´ ì•„ë‹ˆë©´ì„œ ìë¦¬ì— ì—†ë˜ ì‚¬ëŒ"
                
                // ë¡œì§: ê²°ì„ìëŠ” 'ë¯¸ë“±ì›' ì¹¸ì— ìˆìœ¼ë‹ˆ êµì‹œì¹¸ì—” ì•ˆì ìŒ(ì‚¬ì§„ì°¸ê³ ). 
                // êµì‹œì¹¸ì—” "ì´ì„ì(3)"ë§Œ ì ê±°ë‚˜, ê²°ì„ìë„ í¬í•¨í•´ì„œ ì ê±°ë‚˜.
                // í¸ì˜ìƒ: êµì‹œì¹¸ì—ëŠ” "í˜„ì¬ ìë¦¬ì— ì—†ëŠ” ì‚¬ëŒ ì´ë¦„"ì„ ì ë˜, ê²°ì„/ì¡°í‡´ìëŠ” ê´„í˜¸ì²˜ë¦¬í•˜ê±°ë‚˜ ì œì™¸.
                // ì‚¬ì§„ ìŠ¤íƒ€ì¼: ìˆ«ìëŠ” "ì¶œì„í•œ ì¸ì›". ì´ë¦„ì€ "ë¹ ì§„ì• ë“¤"
                
                if (pStatus === 3) missingNames.push(s.name); // ì´ì„ìë§Œ ì´ë¦„ í‘œì‹œ (ê²°ì„ìëŠ” ìœ„ì—ì„œ ë´¤ìœ¼ë‹ˆê¹Œ)
            } else {
                presentCount++;
            }
        });

        return { presentCount, missingNames };
    }

    // --- ê¸°íƒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
    renderPeriodButtons();
    chkLayout.onchange = renderSeats;
    chkEditName.onchange = renderSeats;

    document.getElementById('btnResize').onclick = () => {
        const c = document.getElementById('colsInput').value;
        const r = document.getElementById('rowsInput').value;
        if(confirm(`ë°°ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ê³  ${r}x${c}ë¡œ ë³€ê²½í•©ë‹ˆê¹Œ?`)) {
            const newData = Array(r*c).fill(null).map(()=>({name:"ë¹ˆìë¦¬", isVisible:true}));
            set(ref(database, `academy/config/${currentClassIndex}/rows`), Number(r));
            set(ref(database, `academy/config/${currentClassIndex}/cols`), Number(c));
            set(ref(database, `academy/config/${currentClassIndex}/students`), newData);
        }
    };
    
    // ì˜ëŒ€ë°˜ ì´ˆê¸°í™” ë²„íŠ¼ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
    document.getElementById('btnLoadMedical').onclick = () => {
        if(!confirm("ì˜ëŒ€ë°˜ ë°°ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const ROWS=7; const COLS=6;
        const col1=["í•˜ì§€ìƒ","ê¹€ì„ ì¤€","ì‹¬í˜„ìš°","íƒë¯¼í˜","í•˜ì§€ì•ˆ","ì˜¤ë™ìš´","ê¹€ì€í™©"];
        const col3=["ê¹€ê·œì›","ìµœì„œìœ¤","ì´ì—¬ë¹ˆ","ê¹€ë¯¼í˜¸","ì „ì˜ˆì„œ","ì„ë‚¨ê²½",""];
        const col4=["ì†ì¤€ë¯¼","ì˜¤ì£¼í•˜","ì„ì„¸ì€","ê¹€ì€ì„œ","ê¹€ë¯¼ì§€","ë°•ë¦¬ì›",""];
        const col6=["ì„œíœ˜ì°¬","ì¡°ìœ ë¹ˆ","ê¹€íƒœë¦¼","ì†ì¤€ì„œ","í™©ê±´ìš°","ì²œì„œì˜","ì¶œì…ë¬¸"];
        let newStudents=[];
        for(let r=0; r<ROWS; r++){
            for(let c=0; c<COLS; c++){
                let name="ë¹ˆìë¦¬"; let vis=true;
                if(c===0) name=col1[r]||"ë¹ˆìë¦¬";
                else if(c===1) vis=false;
                else if(c===2){ name=col3[r]||"ë¹ˆìë¦¬"; if(r===6) vis=false; }
                else if(c===3){ name=col4[r]||"ë¹ˆìë¦¬"; if(r===6) vis=false; }
                else if(c===4) vis=false;
                else if(c===5){ name=col6[r]||"ë¹ˆìë¦¬"; if(name==="ì¶œì…ë¬¸") vis=false; }
                newStudents.push({name:name, isVisible:vis});
            }
        }
        set(ref(database, `academy/config/0`), { name:"ì˜ëŒ€ë°˜(101)", rows:ROWS, cols:COLS, students:newStudents });
    };

</script>
</body>
</html>
        authDomain: "attendence-e9aa8.firebaseapp.com",
        projectId: "attendence-e9aa8",
        storageBucket: "attendence-e9aa8.firebasestorage.app",
        messagingSenderId: "449396483783",
        appId: "1:449396483783:web:091b692225089b85a140e2",
        measurementId: "G-5DW7DFXBSC"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const CLASSES = ['ì˜ëŒ€ë°˜(101)', 'Bë°˜', 'Cë°˜', 'Dë°˜', 'Eë°˜', 'Fë°˜'];
    const STATUS_TEXT = ['ì¶œì„', 'ê²°ì„', 'ì¡°í‡´'];
    const STATUS_CLASS = ['present', 'absent', 'early'];
    
    let currentClassIndex = 0;
    let dbData = {}; 

    const gridEl = document.getElementById('seatGrid');
    const tabsEl = document.getElementById('classTabs');
    const countPresentEl = document.getElementById('countPresent');
    const countAbsentEl = document.getElementById('countAbsent');
    const countEarlyEl = document.getElementById('countEarly');
    const chkEditName = document.getElementById('modeEditName');
    const chkLayout = document.getElementById('modeLayout');
    const layoutControls = document.getElementById('layoutControls');

    // DB ì—°ê²°
    const dbRef = ref(database, 'academy/classes');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            dbData = data;
            render();
        } else {
            initDB();
        }
    });

    function initDB() {
        let initialData = {};
        CLASSES.forEach((cls, idx) => {
            initialData[idx] = {
                name: cls,
                rows: 6,
                cols: 5,
                students: Array(30).fill(null).map(() => ({ name: "ë¹ˆìë¦¬", status: 0, isVisible: true }))
            };
        });
        set(ref(database, 'academy/classes'), initialData);
    }

    // --- ğŸ“¸ ì˜ëŒ€ë°˜ ë°ì´í„° ê°•ì œ ì„¤ì • ---
    document.getElementById('btnLoadMedical').onclick = () => {
        if(!confirm("âš ï¸ í˜„ì¬ 'ì˜ëŒ€ë°˜(101)'ì˜ ë°°ì¹˜ê°€ ì‚¬ì§„ê³¼ ë˜‘ê°™ì´ ë³€ê²½ë©ë‹ˆë‹¤.\nê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
        
        // êµ¬ì¡°: [1ì¸ì‹¤] [ë¹ˆì¹¸] [ì™¼ìª½ì±…ìƒ] [ì˜¤ë¥¸ìª½ì±…ìƒ] [ë¹ˆì¹¸] [ì°½ê°€ì±…ìƒ]
        const ROWS = 7;
        const COLS = 6;
        
        const col1_single = ["í•˜ì§€ìƒ", "ê¹€ì„ ì¤€", "ì‹¬í˜„ìš°", "íƒë¯¼í˜", "í•˜ì§€ì•ˆ", "ì˜¤ë™ìš´", "ê¹€ì€í™©"];
        const col3_left   = ["ê¹€ê·œì›", "ìµœì„œìœ¤", "ì´ì—¬ë¹ˆ", "ê¹€ë¯¼í˜¸", "ì „ì˜ˆì„œ", "ì„ë‚¨ê²½", ""];
        const col4_right  = ["ì†ì¤€ë¯¼", "ì˜¤ì£¼í•˜", "ì„ì„¸ì€", "ê¹€ì€ì„œ", "ê¹€ë¯¼ì§€", "ë°•ë¦¬ì›", ""];
        const col6_window = ["ì„œíœ˜ì°¬", "ì¡°ìœ ë¹ˆ", "ê¹€íƒœë¦¼", "ì†ì¤€ì„œ", "í™©ê±´ìš°", "ì²œì„œì˜", "ì¶œì…ë¬¸"];

        let newStudents = [];

        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                let name = "ë¹ˆìë¦¬";
                let isVisible = true;

                if(c === 0) name = col1_single[r] || "ë¹ˆìë¦¬";
                else if(c === 1) isVisible = false; 
                else if(c === 2) {
                    name = col3_left[r] || "ë¹ˆìë¦¬";
                    if(r === 6) isVisible = false;
                }
                else if(c === 3) {
                    name = col4_right[r] || "ë¹ˆìë¦¬";
                    if(r === 6) isVisible = false;
                }
                else if(c === 4) isVisible = false;
                else if(c === 5) {
                    name = col6_window[r] || "ë¹ˆìë¦¬";
                    if(name === "ì¶œì…ë¬¸") isVisible = false;
                }

                newStudents.push({ name: name, status: 0, isVisible: isVisible });
            }
        }

        set(ref(database, `academy/classes/0`), {
            name: "ì˜ëŒ€ë°˜(101)",
            rows: ROWS,
            cols: COLS,
            students: newStudents
        });

        alert("âœ… ì˜ëŒ€ë°˜ ë°°ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    function render() {
        tabsEl.innerHTML = '';
        CLASSES.forEach((clsName, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentClassIndex ? 'active' : ''}`;
            btn.innerText = dbData[idx]?.name || clsName;
            btn.onclick = () => { currentClassIndex = idx; render(); };
            tabsEl.appendChild(btn);
        });

        const currentData = dbData[currentClassIndex];
        if(!currentData) return;

        const isLayoutMode = chkLayout.checked;
        if(isLayoutMode) {
            layoutControls.classList.add('show');
            gridEl.classList.add('editing');
            document.body.classList.add('mode-editing');
            chkEditName.checked = false; 
        } else {
            layoutControls.classList.remove('show');
            gridEl.classList.remove('editing');
            document.body.classList.remove('mode-editing');
        }

        document.getElementById('colsInput').value = currentData.cols;
        document.getElementById('rowsInput').value = currentData.rows;

        gridEl.innerHTML = '';
        gridEl.style.gridTemplateColumns = `repeat(${currentData.cols}, 1fr)`;

        let p=0, a=0, e=0;

        currentData.students.forEach((student, seatIdx) => {
            const seat = document.createElement('div');
            seat.className = `seat ${STATUS_CLASS[student.status]}`;
            if (student.isVisible === false) seat.className += ' hidden-seat';

            seat.innerHTML = `
                <div class="seat-name">${student.name}</div>
                <div class="seat-status">${STATUS_TEXT[student.status]}</div>
            `;
            
            if(student.isVisible !== false) {
                if(student.status === 0) p++;
                else if(student.status === 1) a++;
                else if(student.status === 2) e++;
            }

            seat.onclick = () => handleSeatClick(seatIdx);
            gridEl.appendChild(seat);
        });

        countPresentEl.innerText = p;
        countAbsentEl.innerText = a;
        countEarlyEl.innerText = e;
    }

    function handleSeatClick(seatIdx) {
        const currentData = dbData[currentClassIndex];
        const updatedStudents = [...currentData.students];
        const student = {...updatedStudents[seatIdx]};
        
        if (chkLayout.checked) {
            student.isVisible = !(student.isVisible ?? true);
            if(student.isVisible) student.name = "ë¹ˆìë¦¬";
            saveStudent(seatIdx, student);
            return;
        }

        if (chkEditName.checked) {
            if(student.isVisible === false) return; 
            const newName = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", student.name);
            if (newName !== null) {
                student.name = newName;
                saveStudent(seatIdx, student);
            }
            return;
        }

        if(student.isVisible === false) return;
        let nextStatus = (student.status + 1) % 3;
        student.status = nextStatus;
        saveStudent(seatIdx, student);
    }

    function saveStudent(seatIdx, studentData) {
        const updatedStudents = [...dbData[currentClassIndex].students];
        updatedStudents[seatIdx] = studentData;
        set(ref(database, `academy/classes/${currentClassIndex}/students`), updatedStudents);
    }

    chkLayout.onchange = render;
    chkEditName.onchange = render;

    document.getElementById('btnResize').onclick = () => {
        const newCols = parseInt(document.getElementById('colsInput').value);
        const newRows = parseInt(document.getElementById('rowsInput').value);
        if(!newCols || !newRows) return;
        if(confirm(`ì£¼ì˜: ì¹¸ ìˆ˜ë¥¼ ë°”ê¾¸ë©´ ë°°ì¹˜ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n${newRows}ì¤„ x ${newCols}ì¹¸ìœ¼ë¡œ ë‹¤ì‹œ ë§Œë“¤ê¹Œìš”?`)) {
            const totalSeats = newCols * newRows;
            const newStudents = Array(totalSeats).fill(null).map(() => ({ name: "ë¹ˆìë¦¬", status: 0, isVisible: true }));
            set(ref(database, `academy/classes/${currentClassIndex}/cols`), newCols);
            set(ref(database, `academy/classes/${currentClassIndex}/rows`), newRows);
            set(ref(database, `academy/classes/${currentClassIndex}/students`), newStudents);
        }
    };

    document.getElementById('btnReset').onclick = () => {
        if(confirm("ëª¨ë‘ 'ì¶œì„' ìƒíƒœë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            const currentStudents = dbData[currentClassIndex].students;
            const resetStudents = currentStudents.map(s => ({ ...s, status: 0 }));
            set(ref(database, `academy/classes/${currentClassIndex}/students`), resetStudents);
        }
    };
</script>

</body>
</html>
