<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ í•™ì› ì¶œì„ë¶€</title>
    <style>
        /* ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e5e7eb; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; min-width: 60px; }
        .tab-btn.active { background: #3b82f6; color: white; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .counts span { margin-right: 15px; font-weight: bold; }
        .seat-grid { display: grid; gap: 10px; margin-top: 20px; }
        .seat { aspect-ratio: 1.2; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none; background: white; padding: 5px; text-align: center; }
        .seat:active { transform: scale(0.95); }
        .seat.present { border-color: #059669; background-color: #ecfdf5; color: #065f46; } 
        .seat.absent { border-color: #dc2626; background-color: #fef2f2; color: #991b1b; } 
        .seat.early { border-color: #d97706; background-color: #fffbeb; color: #92400e; }
        .seat-name { font-weight: bold; font-size: 1.1rem; }
        .seat-status { font-size: 0.8rem; margin-top: 5px; }
        .btn-update { background: #4b5563; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-reset { background: #ef4444; color: white; border: none; padding: 8px; width: 100%; border-radius: 8px; margin-top: 20px; cursor: pointer; }
        .loading { text-align: center; padding: 20px; font-size: 1.2rem; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“¡ ì‹¤ì‹œê°„ í•™ì› ì¶œì„ë¶€</h1>

    <div class="tabs" id="classTabs"></div>

    <div class="status-bar">
        <div class="counts">
            <span style="color:#059669">ì¶œì„: <span id="countPresent">0</span></span>
            <span style="color:#dc2626">ê²°ì„: <span id="countAbsent">0</span></span>
            <span style="color:#d97706">ì¡°í‡´: <span id="countEarly">0</span></span>
        </div>
        <label style="display:flex; align-items:center; gap:5px; font-size:14px;">
            <input type="checkbox" id="editMode"> ì´ë¦„ ìˆ˜ì • ëª¨ë“œ
        </label>
    </div>

    <div style="margin-bottom: 10px; text-align: right; font-size: 14px; color: #666;">
        ê°€ë¡œ: <input type="number" id="colsInput" min="1" max="10" style="width:40px;"> 
        ì„¸ë¡œ: <input type="number" id="rowsInput" min="1" max="10" style="width:40px;"> 
        <button class="btn-update" id="btnLayout">ë°°ì¹˜ ë³€ê²½</button>
    </div>

    <div id="seatGrid" class="seat-grid">
        <div class="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <button class="btn-reset" id="btnReset">ì˜¤ëŠ˜ ì¶œê²° ì´ˆê¸°í™” (ëª¨ë‘ ì¶œì„ìœ¼ë¡œ)</button>
</div>

<script type="module">
    // Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // -----------------------------------------------------------
    // [ì¤‘ìš”] ì•„ë˜ ê´„í˜¸ { } ì•ˆì— ì•„ê¹Œ ë³µì‚¬í•œ firebaseConfig ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "ì—¬ê¸°ì—_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”",
        authDomain: "...",
        projectId: "...",
        storageBucket: "...",
        messagingSenderId: "...",
        appId: "..."
    };
    // -----------------------------------------------------------

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ì „ì—­ ë³€ìˆ˜
    const CLASSES = ['Aë°˜', 'Bë°˜', 'Cë°˜', 'Dë°˜', 'Eë°˜', 'Fë°˜'];
    const STATUS_TEXT = ['ì¶œì„', 'ê²°ì„', 'ì¡°í‡´'];
    const STATUS_CLASS = ['present', 'absent', 'early'];
    let currentClassIndex = 0;
    let dbData = {}; 

    // DOM ìš”ì†Œ
    const gridEl = document.getElementById('seatGrid');
    const tabsEl = document.getElementById('classTabs');
    const countPresentEl = document.getElementById('countPresent');
    const countAbsentEl = document.getElementById('countAbsent');
    const countEarlyEl = document.getElementById('countEarly');

    // 1. ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€ (ì œì¼ ì¤‘ìš”!)
    const dbRef = ref(database, 'academy/classes');
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            dbData = data; // ë°ì´í„° ì—…ë°ì´íŠ¸
            render();      // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        } else {
            // ë°ì´í„°ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            initDB();
        }
    });

    // ì´ˆê¸° ë°ì´í„° ìƒì„± í•¨ìˆ˜
    function initDB() {
        let initialData = {};
        CLASSES.forEach((cls, idx) => {
            initialData[idx] = {
                name: cls,
                rows: 4,
                cols: 4,
                students: Array(16).fill({ name: "ë¹ˆìë¦¬", status: 0 })
            };
        });
        set(ref(database, 'academy/classes'), initialData);
    }

    // í™”ë©´ ê·¸ë¦¬ê¸°
    function render() {
        // íƒ­ ë Œë”ë§
        tabsEl.innerHTML = '';
        CLASSES.forEach((clsName, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${idx === currentClassIndex ? 'active' : ''}`;
            btn.innerText = dbData[idx]?.name || clsName;
            btn.onclick = () => { currentClassIndex = idx; render(); };
            tabsEl.appendChild(btn);
        });

        const currentData = dbData[currentClassIndex];
        if(!currentData) return;

        // ì…ë ¥ì°½ ê°’
        document.getElementById('colsInput').value = currentData.cols;
        document.getElementById('rowsInput').value = currentData.rows;

        // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
        gridEl.innerHTML = '';
        gridEl.style.gridTemplateColumns = `repeat(${currentData.cols}, 1fr)`;

        let p=0, a=0, e=0;

        currentData.students.forEach((student, seatIdx) => {
            const seat = document.createElement('div');
            seat.className = `seat ${STATUS_CLASS[student.status]}`;
            seat.innerHTML = `<div class="seat-name">${student.name}</div><div class="seat-status">${STATUS_TEXT[student.status]}</div>`;
            
            // ì¹´ìš´íŠ¸ (ë¹ˆìë¦¬ê°€ ì•„ë‹ˆê±°ë‚˜, ë¹ˆìë¦¬ë¼ë„ ìƒíƒœê°€ ìˆìœ¼ë©´ ì¹´ìš´íŠ¸)
            if(student.status === 0) p++;
            else if(student.status === 1) a++;
            else if(student.status === 2) e++;

            seat.onclick = () => handleSeatClick(seatIdx);
            gridEl.appendChild(seat);
        });

        countPresentEl.innerText = p;
        countAbsentEl.innerText = a;
        countEarlyEl.innerText = e;
    }

    // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleSeatClick(seatIdx) {
        const isEditMode = document.getElementById('editMode').checked;
        const currentData = dbData[currentClassIndex];
        
        // ë°ì´í„° ë³µì‚¬ë³¸ ìƒì„±
        const updatedStudents = [...currentData.students];
        const student = {...updatedStudents[seatIdx]};

        if (isEditMode) {
            const newName = prompt("í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", student.name);
            if (newName !== null) {
                student.name = newName;
                updatedStudents[seatIdx] = student;
                // Firebaseì— ì €ì¥
                set(ref(database, `academy/classes/${currentClassIndex}/students`), updatedStudents);
            }
        } else {
            let nextStatus = (student.status + 1) % 3;
            student.status = nextStatus;
            updatedStudents[seatIdx] = student;
            // Firebaseì— ì €ì¥ (ë³€ê²½ëœ í•™ìƒ ë¦¬ìŠ¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸)
            set(ref(database, `academy/classes/${currentClassIndex}/students`), updatedStudents);
        }
    }

    // ë°°ì¹˜ ë³€ê²½ ë²„íŠ¼
    document.getElementById('btnLayout').onclick = () => {
        const newCols = parseInt(document.getElementById('colsInput').value);
        const newRows = parseInt(document.getElementById('rowsInput').value);
        if(!newCols || !newRows) return;

        if(confirm(`ë°°ì¹˜ë¥¼ ${newRows}ì¤„ x ${newCols}ì¹¸ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const totalSeats = newCols * newRows;
            const oldStudents = dbData[currentClassIndex].students;
            let newStudents = [];
            for(let i=0; i<totalSeats; i++) {
                newStudents.push(oldStudents[i] || { name: "ë¹ˆìë¦¬", status: 0 });
            }
            
            // Firebaseì— ì—…ë°ì´íŠ¸
            set(ref(database, `academy/classes/${currentClassIndex}/cols`), newCols);
            set(ref(database, `academy/classes/${currentClassIndex}/rows`), newRows);
            set(ref(database, `academy/classes/${currentClassIndex}/students`), newStudents);
        }
    };

    // ì´ˆê¸°í™” ë²„íŠ¼
    document.getElementById('btnReset').onclick = () => {
        if(confirm("ëª¨ë‘ 'ì¶œì„' ìƒíƒœë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
            const currentStudents = dbData[currentClassIndex].students;
            const resetStudents = currentStudents.map(s => ({ ...s, status: 0 }));
            set(ref(database, `academy/classes/${currentClassIndex}/students`), resetStudents);
        }
    };
</script>

</body>
</html>

